[![Build Status](https://travis-ci.org/serg-nik/foodvoice.svg?branch=master)](https://travis-ci.org/serg-nik/foodvoice)

# FoodVoice

FoodVoice - это реализация [выпускного проекта](graduation.md "Полное описание проекта") по итогам курса "TopJava".

## Описание

Основное назначение сервиса - выбор ресторана для обеда. Для этого любой желающий может просмотреть список ресторанов с 
их меню дня (актуальное меню на сегодня), а, чтобы проголосовать за ресторан, нужно отправить запрос с идентификатором 
меню, которое приглянулось (выбирая меню пользователь выбирает ресторан).

В системе есть две роли "USER" и "ADMIN", которым доступны разные ресурсы API.

Для тестирования в базе данных при каждом запуске приложения (БД в режиме "In-Memory") популируются тестовые данные:
* Пользователь "ADMIN" с обеими ролями
* Пользователь "USER" с одноимённой ролью
* 2 активных ресторана с их актуальным меню
* голоса - история выбора пользователей ресторанов для обеда

### Ориентация на frontend

Так как в постановке фигурирует "without frontend" и есть рекомендация думать в ключе "API для внешнего интерфейса", в
проекте были использованы часто применяемые практики:
* Использование UUID в качестве id (минимизирует риски коллизий и подбора id)
* JSON Web Token (JWT) аутентификация
* Запросы наборов с постраничной загрузкой (и, возможной, сортировкой)
* Версионирование ресурсов
* OpenAPI документация

### Кэширование

В приложении предусмотрено кэширование частых и тяжёлых запросов для снижения нагрузки на базу данных. Кэш сбрасывается 
при изменениях кэшируемых сущностей:
1. Все рестораны с их меню дня (доступен всем)
2. Все рестораны с полным списком меню (доступен администраторам)
3. Аутентификация - если в запросе есть JWT-токен, то происходит загрузка пользователя из базы данных, после 
первого обращения данные кэшируются

### Стек

За основу разработки был выбран [Spring Boot](https://spring.io/projects/spring-boot), а в целом стек выглядит 
следующим образом:

* Java 14 (OpenJDK 14)
* Maven
* Spring Boot
* Spring Security
* Spring Web
* Spring Data JPA
* Lombok
* H2 Database
* Flyway Migration
* Swagger 2

## Запуск приложения

После скачивания и импортирования проекта в любимую IDE, приложение можно запустить:

1. Через точку входа: `ru.serg_nik.foodvoice.FoodVoiceApplication`
2. Выполнив команду в консоли: `mvn spring-boot:run` (если настроена переменная "M2_HOME")

## Использование API

После запуска приложения, его документация будет доступна по ссылке: http://localhost:8080/swagger-ui.html
Перейдя по ссылке откроется веб-интерфейс с набором ресурсов и моделей, где можно выполнять запросы к API приложения,
для этого нужно:
1. Выбрать ресурс, например, `auth-rest-controller-v-1` -> `POST /api/v1/login/`, который авторизует пользователя
2. Раскрыть его, нажать на кнопку `Try it out`
3. После чего нажать на появившуюся кнопку `Execute`

Будет выполнен для авторизации администратора (тестовый шаблон), в ответ на который будет получен JSON-объект 
(Response body):

```json
{
  "email": "admin@foodvoice.ru",
  "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbkBmb29kdm9pY2UucnUiLCJyb2xlcyI6WyJST0xFX1VTRVIiLCJST0xFX0FETUlOIl0sImlhdCI6MTU4OTQwNzMyNywiZXhwIjoxNTg5NDEwOTI3fQ.aD2Vpl-_SSHXYRNfE6sB6KF_Y5nlvbOeIzWPvOvDET0"
}
``` 

JWT-токен потребуется для выполнения запросов, где требуется авторизация (подробнее в таблицах ниже).
Для авторизации запросов в Swagger необходимо:
1. Скопировать токен
2. Справа вверху страницы нажать на кнопку `Authorize`
3. В появившемся окне ввести в поле "Value:" значение `Bearer_` и вставить скопированный токен
4. Нажать на кнопку `Authorize`

После этих действий все запросы будут отправляться с правами пользователя-владельца токена.

### Доступные ресурсы API

В первый релиз приложения вошли не все необходимые для работы ресурсы. Ресурсы разбиты на таблицы по необходимым для
доступа правам:

#### Не авторизованные пользователи

Бизнес-кейс | Метод | Ресурс | Кэширование
----------- | ----- | ------ | -----------
Просмотр списка ресторанов с их меню дня | GET | /api/v1/restaurants/menus/actual | Да
Регистрация нового пользователя | POST | /api/v1/register | Нет
Авторизация пользователя | POST | /api/v1/login | Нет

#### Авторизованные пользователи

Бизнес-кейс | Метод | Ресурс | Кэширование
----------- | ----- | ------ | -----------
Выбор ресторан (его меню) для обеда | POST | /api/v1/voices | Нет
Изменение выбранного ресторана | PUT | /api/v1/voices/{id} | Нет
Просмотр история своего голосования | GET | /api/v1/voices/my | Нет

#### Авторизованные администраторы

Бизнес-кейс | Метод | Ресурс | Кэширование
----------- | ----- | ------ | -----------
Просмотр списка ресторанов с их меню | GET | /api/v1/restaurants | Да
Добавление ресторана с/без его меню | POST | /api/v1/restaurants | Нет
Просмотр ресторана с его меню | GET | /api/v1/restaurants/{id} | Нет
Добавление меню ресторана | POST | /api/v1/restaurants/{id}/menus | Нет
Просмотр меню ресторана | GET | /api/v1/menus/{id} | Нет
Изменение/установка меню дня ресторана | PUT | /api/v1/menus/{id}?actual= | Нет
Изменение пользователя | PUT | /api/v1/users/{id} | Нет